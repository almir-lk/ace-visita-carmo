// ============================================
// CONFIGURA√á√ÉO - SUBSTITUA PELA SUA URL!
// ============================================

const CONFIG = {
    API_URL: 'https://script.google.com/macros/s/AKfycbxUgS-1L8rNPfmjl0fjb2Cd2H4R5MB-AB0NIETodz1OrKdSjMquLDVA-dvOYthJXZRR/exec',
    ITENS_POR_PAGINA: 50
};

// ============================================
// VARI√ÅVEIS GLOBAIS
// ============================================

let todosOsDados = [];
let dadosFiltrados = [];
let paginaAtual = 1;
let ordenacao = { campo: 'Data', direcao: 'desc' }; // Usar nome da coluna direto

// ============================================
// INICIALIZA√á√ÉO
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ App de consulta iniciado');
    
    // Definir datas padr√£o (√∫ltimos 30 dias)
    const hoje = new Date();
    const trintaDiasAtras = new Date(hoje.getTime() - (30 * 24 * 60 * 60 * 1000));
    
    document.getElementById('filtroDataFim').valueAsDate = hoje;
    document.getElementById('filtroDataInicio').valueAsDate = trintaDiasAtras;
    
    // Carregar dados automaticamente
    carregarDados();
});

// ============================================
// CARREGAMENTO DE DADOS
// ============================================

async function carregarDados() {
    console.log('üì• Carregando dados...');
    mostrarLoading(true);
    
    try {
        // Usar JSONP para evitar CORS
        const url = CONFIG.API_URL + '?action=getData&callback=handleData';
        
        console.log('URL da requisi√ß√£o:', url);
        
        // Criar script tag para JSONP
        const script = document.createElement('script');
        script.src = url;
        
        // Timeout de seguran√ßa
        const timeoutId = setTimeout(() => {
            console.error('‚è±Ô∏è Timeout ao carregar dados');
            limparDados();
            showToast('Timeout ao carregar. Tente novamente.', 'error');
            mostrarLoading(false);
        }, 10000);
        
        // Handler global para JSONP
        window.handleData = function(result) {
            clearTimeout(timeoutId);
            console.log('‚úÖ Dados recebidos via JSONP:', result);
            
            if (result && result.success && Array.isArray(result.data)) {
                todosOsDados = result.data;
                console.log('üìä Total de registros:', todosOsDados.length);
                
                popularFiltrosDinamicos();
                aplicarFiltros();
            } else {
                console.error('‚ùå Resposta inv√°lida:', result);
                limparDados();
                showToast('Erro: ' + (result.message || 'Dados inv√°lidos'), 'error');
            }
            
            mostrarLoading(false);
            
            // Limpar script
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleData;
        };
        
        // Handler de erro
        script.onerror = function() {
            clearTimeout(timeoutId);
            console.error('‚ùå Erro ao carregar script');
            limparDados();
            showToast('Erro de conex√£o com a API', 'error');
            mostrarLoading(false);
            
            if (script.parentNode) {
                script.parentNode.removeChild(script);
            }
            delete window.handleData;
        };
        
        document.head.appendChild(script);
        
    } catch (error) {
        console.error('‚ùå Erro carregarDados:', error);
        limparDados();
        showToast('Erro: ' + error.message, 'error');
        mostrarLoading(false);
    }
}

// Fallback: carregar via fetch com no-cors (s√≥ funciona se API permitir)
async function carregarDadosFetch() {
    try {
        const response = await fetch(CONFIG.API_URL + '?action=getData', {
            method: 'GET',
            mode: 'cors', // Tentar CORS normal primeiro
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (!response.ok) throw new Error('HTTP ' + response.status);
        
        const result = await response.json();
        
        if (result.success && result.data) {
            todosOsDados = result.data;
            popularFiltrosDinamicos();
            aplicarFiltros();
        } else {
            throw new Error(result.message || 'Dados inv√°lidos');
        }
        
    } catch (error) {
        console.error('Fetch falhou, tentando JSONP:', error);
        // Se falhar, o JSONP j√° foi iniciado acima
    }
}

function limparDados() {
    todosOsDados = [];
    dadosFiltrados = [];
    popularFiltrosDinamicos();
    aplicarFiltros();
}

function popularFiltrosDinamicos() {
    const selectAgente = document.getElementById('filtroAgente');
    const selectEquipe = document.getElementById('filtroEquipe');
    
    // Limpar op√ß√µes existentes (exceto primeira)
    while (selectAgente.options.length > 1) selectAgente.remove(1);
    while (selectEquipe.options.length > 1) selectEquipe.remove(1);
    
    if (todosOsDados.length === 0) return;
    
    const agentes = [...new Set(todosOsDados.map(d => d.Agente).filter(Boolean))].sort();
    const equipes = [...new Set(todosOsDados.map(d => d.Equipe).filter(Boolean))].sort();
    
    console.log('Agentes encontrados:', agentes.length);
    console.log('Equipes encontradas:', equipes.length);
    
    agentes.forEach(agente => {
        const option = document.createElement('option');
        option.value = agente;
        option.textContent = agente;
        selectAgente.appendChild(option);
    });
    
    equipes.forEach(equipe => {
        const option = document.createElement('option');
        option.value = equipe;
        option.textContent = equipe;
        selectEquipe.appendChild(option);
    });
}

// ============================================
// FILTROS
// ============================================

function aplicarFiltros() {
    console.log('üîç Aplicando filtros...');
    
    const filtros = {
        dataInicio: document.getElementById('filtroDataInicio').value,
        dataFim: document.getElementById('filtroDataFim').value,
        agente: document.getElementById('filtroAgente').value,
        equipe: document.getElementById('filtroEquipe').value,
        microarea: document.getElementById('filtroMicroarea').value.toLowerCase().trim(),
        quarteirao: document.getElementById('filtroQuarteirao').value.toLowerCase().trim(),
        situacao: document.getElementById('filtroSituacao').value,
        logradouro: document.getElementById('filtroLogradouro').value.toLowerCase().trim()
    };
    
    console.log('Filtros:', filtros);
    
    dadosFiltrados = todosOsDados.filter(item => {
        // Verificar se item existe
        if (!item) return false;
        
        // Filtro de data
        if (filtros.dataInicio && item.Data) {
            const dataItem = parseDataBR(item.Data);
            const dataInicio = new Date(filtros.dataInicio);
            if (dataItem < dataInicio) return false;
        }
        
        if (filtros.dataFim && item.Data) {
            const dataItem = parseDataBR(item.Data);
            const dataFim = new Date(filtros.dataFim);
            dataFim.setHours(23, 59, 59);
            if (dataItem > dataFim) return false;
        }
        
        // Filtros de texto exato
        if (filtros.agente && item.Agente !== filtros.agente) return false;
        if (filtros.equipe && item.Equipe !== filtros.equipe) return false;
        if (filtros.situacao && item.Situacao !== filtros.situacao) return false;
        
        // Filtros de texto parcial (com seguran√ßa)
        if (filtros.microarea) {
            const microareaItem = (item.Microarea || '').toLowerCase();
            if (!microareaItem.includes(filtros.microarea)) return false;
        }
        
        if (filtros.quarteirao) {
            const quarteiraoItem = (item.Quarteirao || '').toLowerCase();
            if (!quarteiraoItem.includes(filtros.quarteirao)) return false;
        }
        
        if (filtros.logradouro) {
            const logradouroItem = (item.Logradouro || '').toLowerCase();
            if (!logradouroItem.includes(filtros.logradouro)) return false;
        }
        
        return true;
    });
    
    console.log('Registros ap√≥s filtro:', dadosFiltrados.length);
    
    ordenarDados();
    paginaAtual = 1;
    
    atualizarEstatisticas();
    atualizarGrafico();
    renderizarTabela();
    renderizarPaginacao();
}

function limparFiltros() {
    document.getElementById('filtroDataInicio').value = '';
    document.getElementById('filtroDataFim').value = '';
    document.getElementById('filtroAgente').value = '';
    document.getElementById('filtroEquipe').value = '';
    document.getElementById('filtroMicroarea').value = '';
    document.getElementById('filtroQuarteirao').value = '';
    document.getElementById('filtroSituacao').value = '';
    document.getElementById('filtroLogradouro').value = '';
    
    aplicarFiltros();
}

// ============================================
// ORDENA√á√ÉO
// ============================================

function ordenarPor(campo) {
    // Mapear nomes de exibi√ß√£o para nomes das colunas
    const campoMap = {
        'data': 'Data',
        'hora': 'Hora',
        'agente': 'Agente',
        'equipe': 'Equipe',
        'logradouro': 'Logradouro',
        'numero': 'Numero',
        'microarea': 'Microarea',
        'situacao': 'Situacao',
        'depositosPositivos': 'Depositos_Positivos'
    };
    
    const campoReal = campoMap[campo] || campo;
    
    if (ordenacao.campo === campoReal) {
        ordenacao.direcao = ordenacao.direcao === 'asc' ? 'desc' : 'asc';
    } else {
        ordenacao.campo = campoReal;
        ordenacao.direcao = 'asc';
    }
    
    document.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    
    const thAtivo = document.querySelector(`th[onclick="ordenarPor('${campo}')"]`);
    if (thAtivo) {
        thAtivo.classList.add(`sort-${ordenacao.direcao}`);
    }
    
    ordenarDados();
    renderizarTabela();
}

function ordenarDados() {
    dadosFiltrados.sort((a, b) => {
        let valA = a[ordenacao.campo] || '';
        let valB = b[ordenacao.campo] || '';
        
        // Tratamento especial para datas
        if (ordenacao.campo === 'Data') {
            valA = parseDataBR(valA).getTime();
            valB = parseDataBR(valB).getTime();
        }
        
        // Tratamento para n√∫meros
        if (!isNaN(valA) && !isNaN(valB) && valA !== '' && valB !== '') {
            valA = Number(valA);
            valB = Number(valB);
        }
        
        // Converter para string para compara√ß√£o segura
        valA = String(valA).toLowerCase();
        valB = String(valB).toLowerCase();
        
        if (valA < valB) return ordenacao.direcao === 'asc' ? -1 : 1;
        if (valA > valB) return ordenacao.direcao === 'asc' ? 1 : -1;
        return 0;
    });
}

// ============================================
// ESTAT√çSTICAS E GR√ÅFICOS
// ============================================

function atualizarEstatisticas() {
    const total = dadosFiltrados.length;
    const trabalhados = dadosFiltrados.filter(d => d.Situacao === 'normal').length;
    const pendentes = 0; // Na planilha todos est√£o sincronizados
    const positivos = dadosFiltrados.reduce((sum, d) => {
        const val = parseInt(d.Depositos_Positivos);
        return sum + (isNaN(val) ? 0 : val);
    }, 0);
    const agentesUnicos = new Set(dadosFiltrados.map(d => d.Agente).filter(Boolean)).size;
    
    document.getElementById('statTotal').textContent = total;
    document.getElementById('statTrabalhados').textContent = trabalhados;
    document.getElementById('statPendentes').textContent = pendentes;
    document.getElementById('statPositivos').textContent = positivos;
    document.getElementById('statAgentes').textContent = agentesUnicos;
    
    const inicio = (paginaAtual - 1) * CONFIG.ITENS_POR_PAGINA + 1;
    const fim = Math.min(paginaAtual * CONFIG.ITENS_POR_PAGINA, total);
    
    document.getElementById('dataCount').textContent = 
        total > 0 ? `Mostrando ${inicio}-${fim} de ${total} registros` : 'Nenhum registro';
}

function atualizarGrafico() {
    const situacoes = {};
    dadosFiltrados.forEach(d => {
        const sit = d.Situacao || 'desconhecido';
        situacoes[sit] = (situacoes[sit] || 0) + 1;
    });
    
    const total = dadosFiltrados.length;
    const container = document.getElementById('chartContent');
    container.innerHTML = '';
    
    if (total === 0) {
        container.innerHTML = '<p style="text-align: center; color: #9ca3af;">Sem dados para exibir</p>';
        return;
    }
    
    const cores = {
        'normal': '#10b981',
        'fechado': '#ef4444',
        'recusado': '#f97316',
        'desabitado': '#f59e0b',
        'demolido': '#8b5cf6',
        'desconhecido': '#6b7280'
    };
    
    const labels = {
        'normal': 'Trabalhados',
        'fechado': 'Fechados',
        'recusado': 'Recusados',
        'desabitado': 'Desabitados',
        'demolido': 'Demolidos',
        'desconhecido': 'Desconhecido'
    };
    
    Object.entries(situacoes).forEach(([sit, qtd]) => {
        const percentual = total > 0 ? (qtd / total * 100).toFixed(1) : 0;
        
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.innerHTML = `
            <div class="chart-label">${labels[sit] || sit}</div>
            <div class="chart-progress">
                <div class="chart-fill" style="width: ${percentual}%; background: ${cores[sit] || '#2563eb'}"></div>
            </div>
            <div class="chart-value">${qtd} (${percentual}%)</div>
        `;
        container.appendChild(bar);
    });
}

// ============================================
// TABELA E PAGINA√á√ÉO
// ============================================

function renderizarTabela() {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if (dadosFiltrados.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        document.getElementById('tableContainer').classList.add('hidden');
        return;
    }
    
    document.getElementById('emptyState').classList.add('hidden');
    document.getElementById('tableContainer').classList.remove('hidden');
    
    const inicio = (paginaAtual - 1) * CONFIG.ITENS_POR_PAGINA;
    const fim = inicio + CONFIG.ITENS_POR_PAGINA;
    const paginaDados = dadosFiltrados.slice(inicio, fim);
    
    paginaDados.forEach(item => {
        const tr = document.createElement('tr');
        
        const badgeClass = `badge-${item.Situacao || 'normal'}`;
        
        tr.innerHTML = `
            <td>${item.Data || '-'}</td>
            <td>${item.Hora || '-'}</td>
            <td>${item.Agente || '-'}</td>
            <td>${item.Equipe || '-'}</td>
            <td>${item.Logradouro || '-'}</td>
            <td>${item.Numero || '-'}</td>
            <td>${item.Microarea || '-'}</td>
            <td><span class="badge ${badgeClass}">${item.Situacao || 'normal'}</span></td>
            <td>${item.Depositos_Positivos || '0'}</td>
            <td>
                <button onclick="verDetalhes(${item.id})" style="padding: 4px 8px; border: none; background
